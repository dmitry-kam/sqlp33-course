# 4 домашнее задание

Так как БД проектируется для одной аптеки, то логично предположить, что
нагрузки будут незначительны и база даже за годы работы вряд ли 
разрастется до размеров, когда возникнут проблемы со скоростью аналитики. И
даже в этом случае скорее всего разумнее будет агрегировать исторические данные,
максимально их сжав, и перенести в отдельную историческую БД. Выбор СУБД 
непринципиален. Если пофантазировать, что дела у аптеки пошли очень хорошо 
(я сразу заложил таблицу с аптеками и привязку сотрудников, покупки к аптеке,
чтобы в случае роста сразу получить фору на развитие других пожеланий заказчика)
, то я бы отдал предпочтение OLAP, так как важность аналитики и ее скорости 
выглядит более важной, чем просто факт быстрой записи (который можно при
необходимости реализовать через обработчик очередей, если вдруг столкнемся, 
что СУБД стала узким местом), либо к связке нескольких СУБД с использованием
плюсов разных систем. В любом случае, проблемы что с записью, что с аналитикой,
что с хранением/масштабированием/бэкапированиям в заданных условиях выглядят
очень отдаленными и скорее всего до них никогда не дойдет, а если дойдет, 
то скорее всего с множеством других требований от заказчика, которые лучше 
будет перепроектировать в новой БД с учетом прошлых ошибок и мигрировать туда 
данные, чем пытаться создать вечную систему и эксплуатировать ее (к тому же 
стоимость такого решения вырастет кратно, хотя заказчику на данном этапе это
вряд ли вообще нужно). Допустим, что мы выбрали PostgreSQL. Возьмем 1 сервер 
БД (или 2, если дали добро, чтобы повысить надежность системы и бесшовности
работы в случае проблем на одном из серверов), настроим бэкап 2 раза в сутки
(в середине и в конце рабочего дня) – с загрузкой в какое-то внешнее хранилище.

## Роли и уровни доступа:
**Администратор**: CRUD ко всей БД

**Менеджер** _(например, для выдачи директору, менеджеру сети по всему городу):_
чтение на все таблицы

**Бухгалтер**: чтение таблиц по поставщикам, аптекам, поставкам, продажам,
сотрудникам, рабочим дням. По сотрудникам также вставка, обновление

**Фармацевт**: чтение на таблицы по препаратам, товарам в наличии, аналогам; 
чтение, вставка в продажи, чтение по рабочим дням

**Провизор** _(как старший фармацевт, ответственный за заказ товаров и их выкладку)_: 
то же + обновление на продажах (для отмены товара по просьбе фармацевта); чтение, вставка, обновление на таблицы по закупкам и списанным товарам; чтение основной таблице сотрудников (без зарплаты), CRUD по рабочим дням

## Комментарии к схеме:
- в некоторых местах отошел от примера схемы
- добавил таблицу по сущности препаратов (допустим, йод производителя А, йод производителя Б), чтобы иметь возможность создать базу аналогов и группировать (в чеке или аналитике) именно по препарату, а не писать построчно каждую позицию. В то же время вода, шоколадки и т.п. немедицинские товары могут иметь просто NULL drug_id
- категории не реализовывал
- сумму покупки разнес на стоимость доставки и стоимость покупки конкретной позиции в product_fact и продажи вынес 
- продажи вынес как отдельную сущность, которая N..N связана с product_fact через sold_products.
- в рабочих днях для простоты сделал одно поле - дата-время, одно - длительность в часах (во избежание ошибок ввода времени окончания смены). Связанная таблица со статусами смен содержит список возможных статусов (запланирована, отработана, отменена сотрудником и т.д.).
Бизнес-идеи:
- административно: обучаем фармацевтов правильно забирать в ящике товары, разложенные провизором (чем ближе срок годности, тем ближе), заказывать препараты в нужном количестве в соответствии с рекомендациями системы. Вводим KPI, влияющий на премию, прямо зависящий от числа продаж и обратно от числа списанных товаров (за месяц на аптеку, например).

## Идеи для функций для автоматизации: 
- формируем представление, которое показывает все препараты с подходящим к концу сроком годности (с сортировкой по числу дней до конца срока годности, чтобы иметь возможность продать со скидкой, или предложить, как аналог), а в день наступления отображаем провизору препараты, которые необходимо физически списать. Функцией, запускаемой допустим за полчаса до начала смены (и в которой мы указываем за сколько дней до срока на коробке, списываем препарат - баланс между репутационными издержками и дополнительными убытками) и делаем соответствующие отметки в таблицу списаний. Реализуем через pgAgent или cron + вызов скрипта. 
- на таблицу purchases делаем триггер на вставку. Рейтинг, проставленный сотрудником за конкретную доставку (то, как вовремя привезли, в каком состоянии и т.д.) в виде допустим 10 бальной оценки (шкалу можно разработать и довести административно), пересчитывается как среднее всех оценок и проставляется как общий рейтинг поставщика в suppliers (тип enum, как в задании написано, почему-то в DBeaver у меня не проставляется, да и представить конкретное число как ОТЛИЧНО-ХОРОШО-… проще, чем объективно сделать обратное)
- при поиске наличия препарата (можно реализовать через функцию с поиском по типу LIKE %..% и SOUNDEX(..), чтобы помочь фармацевту) и сообщении, что такого товара нет, возвращать список аналогов в наличии (используем таблицы таблицы drug_analogs и product_list)
- сформировать представления по рекомендации заказа препаратов и товаров на основе накопленных данных (выводим столбцы с количеством, купленным в прошлом месяце, в среднем ежемесячно, за календарный этот же месяц в прошлом году), показываем остаток товара в аптеке. В зависимости от того, как работаем с поставщиками (прайс-листы, API, …) – пытаемся сразу показать наличие, количество, цены у конкретных поставщиков
- триггер на вставку product_fact может сразу вычислять наценку (которая может отличаться в зависимости от аптеки) и проставлять ее в поле amount_plan (цена, по которой мы планируем продать) на основании цены закупки + процент наценки + стоимость доставки от поставщика/количество привезенных товаров (например).

## Задачи, которые нужно решить:
### Финансовое планирование, расчет прибыли. Анализ квалификации и эффективност сотрудников
- Формируем ненормализованные отчеты-представления в разрезах аптек, сотрудников (количество и сумма продаж, рабочие дни, неотработанные смены, средние продажи за рабочий день). На базе этого анализируем выбивающиеся показатели, совещаемся с провизором, принимаем какие-либо решения.
- Формируем представления с затратами на затраты сотрудников по аптекам
- Представление по аптекам с группировкой по месяцам (за последние полгода, т.к. продажи скорее всего выходят за рамки месяца и нужно отслеживать эффект с временной задержкой): суммы, затраченные на закупку товаров и сумма продаж; сумма потерь на списанных товарах.

Если окупаемость аптеки не устраивает владельца, то можем изменить наценку.

### Учет рабочего времени сотрудников
Сотрудники, рабочие часы-смены-график, оплата — это отдельная большая тема.
Скорее всего, если будет отдельная должность для бухгалтера, то будет 
использоваться и отдельный софт, не связанный с данной БД. 
В нашем случае можно считать число отработанных смен (в том числе неполные 
смены), отмененные смены (которые несут за собой либо финансовые потери, 
либо дополнительные усилия по замене сотрудника), эффективность сотрудников 
(разумеется, в отрыве от объективных условий, что какие-то дни 
или сезоны могут быть более активными). Смены планируют и отмечают 
провизоры (видимо, их должно быть двое), либо менеджер. Можно сделать 
дополнительно представление для сверки по отработанным сменам 
и совершенным в течение нее продажам или принятию поставок (и 
обратить внимание на смены без действий и наоборот на действия без смены). 

### Актуализация товара в зависимости от спроса	

Представление со списком товаров (с группировкой по полю COALESCENCE(drug_id препарата, либо названию)), которых:
- просто по числу, допустим меньше 3 шт.
- в наличии меньше, чем продано за прошлые 30 дней
- ИЛИ меньше, чем продано товара за аналогичный месяц прошлого года ИЛИ следующий
Таким образом получаем визуализацию, чего не хватает прямо сейчас и чего может не хватить на основании исторических данных.
		
### Контроль поставщиков
Сделал рейтинг конкретной поставки, ранее описал формирование общего рейтинга. 
Провизор ориентируется на цену доставки, на стоимость товаров у поставщика, 
на рейтинг и принимает решение о заказе.

### Учет товара
При принятии товара провизор проверяет все позиции, далее раскладывает по 
ящикам в правильном порядке, прикрепляет этикетку, которую позже считаем 
и проведем продажу на основании конкретной пачки из product_fact.

### Описать формирование значений в атрибуты amount отношений sales и purchases.
В purchases сохраняем стоимость самой доставки, закупочную стоимость самой 
позиции сохраняем в product_fact. В sold_products сохраняем отпускную цену, 
по которой продали товар.

### Описать формирование изменения значения скидки в отношении loyalty_cards
Начинаем транзакцию.

При проведении товара на кассе берется сумма прошлых покупок (purchases_amount) 
и если товар не является уже уцененным (product_fact.discounted) по акции 
или из-за подходящего к концу срока годности, то проставляем 
**sold_products.amount = product_fact.amount_plan * loyalty_cards.discount_percent**.
Считаем новую сумму купленных товаров и записываем ее в loyalty_cards

Завершаем транзакцию.

На таблицу loyalty_cards создаем триггер после обновления, который устанавливает процент скидки в зависимости от суммы покупок.

### Реализовать историчность окладов, должностей и поставщиков в 4 типе SCD.
Историчность должностей в 4 SCD в моей схеме нельзя реализовать, 
т.к. у меня N..N должности-сотрудники и в таблице должностей сотрудников 
исторические данные по занимаемым должностям (возможно совмещение должностей, 
возможно работа на 2 аптеки, если говорить о расширении – думаю, 
что для малого бизнеса стоит предусмотреть такие возможности).

**Оставшиеся 2 исторических таблицы:** employee_salary_history и suppliers_history
